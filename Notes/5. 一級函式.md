# Ch5 First-Class Functions 一級函式

### Agenda
- [將函式視為物件](#將函式視為物件)
- [高階函式](#高階函式)
- [匿名函式](#匿名函式)
- [七種可呼叫物件](#七種可呼叫物件)
- [定義可呼叫型態](#定義可呼叫型態)
- [函式自我檢查](#函式自我檢查)
- [從定位參數到只限使用關鍵字的參數](#從定位參數到只限使用關鍵字的參數)

## 將函式視為物件

Python中的函式是**一級物件**

什麼是一級物件?
 - 可在執行階段建立(runtime)
 - 可被指派一個變數，或資料結構內的元素
 - 可被當成引數，傳給函式
 - 可被當成函式的結果回傳

(p.s. Integers,strings和dictionaries都是Python一集物件的案例)

Define a function: ```factorial```
```python
def factorial(n):
    '''returns n!'''
    return 1 if n < 2 else n * factorial(n-1)
```

```python
factorial(42) # 1405006117752879898543142606244511569936384000000000
factorial.__doc__ # 'returns n!'
type(factorial) # <class 'function'>
```
也可以指派給變數，並將函式當成引數傳入
```python
fact = factorial
fact(5) # 120
map(fact, range(6)) # <map object at 0x7fedf01980d0>
list(map(fact, range(6))) # [1, 1, 2, 6, 24, 120]
```


## 高階函式

何謂**高階函式**?
- 函式會將另一個函式當成引數來使用
- 將函式當成結果來回傳

以內建函式```sorted```舉例

```python
fruits = ['strawberry', 'fig', 'apple', 'cherry', 'raspberry', 'banana']
sorted(fruits, key=len) #用len()方法來做排序
# ['fig', 'apple', 'cherry', 'banana', 'raspberry', 'strawberry']
```

```sorted```裡面的key可以帶入任何函式的引數，比如說自己寫一個把字串反向拼寫的方法

```python
def reverse(word):
    return word[::-1]

reverse('testing') # 'gnitset'
```

當成key帶入
```python
sorted(fruits, key=reverse)
# ['banana', 'apple', 'fig', 'raspberry', 'strawberry', 'cherry']
```

### 現代map, filter, refuce的替代物
```map``` ```filter```和```reduce```是最著名的高階函數，但現在已經可以用```listcomp```,```genexp```來替換他們的工作

(more informations of genexp can ref: https://towardsdatascience.com/understanding-generator-expressions-in-python-fe0c4534619)

```python
list(map(fact, range(6)))
list(map(fact, filter(lambda n: n%2, range(6))))
```
用listcomp的寫法變成
```python
[fact(n) for n in range(6)]
[fact(n) for n in range(6) if n%2]
```
在python2，這些函式會回傳串列，因此他們的替代物是listcomp
在python3，這些函式會回傳迭代器，因此他們的替代物是genexp

 - [map函式文件](https://www.runoob.com/python/python-func-map.html)
 - [filter函式文件](https://www.runoob.com/python/python-func-filter.html)

在Python3，reduce()已經被移到functools模組裡，如果我們要使用，需要import functools才能用reduce()函数

```python
from functools import reduce
from operator import add
reduce(add, range(100)) # 4950

#after python 2.3, "sum" can be the substitute of "reduce"
sum(range(100)) # 4950
```

## 匿名函式
 - 使用```lambda```關鍵字
 - ```lambda```內不能賦值
 - 不能使用python陳述式，如while, try等

**最佳使用時機： 在使用引述串列的情況下，如先前提到的反向函數。**


```python
fruits = ['strawberry', 'fig', 'apple', 'cherry', 'raspberry', 'banana']
sorted(fruits, key=lambda word: word[::-1])
```
不過lambda的使用時機不多，且有時候也複雜難以閱讀，在python中不太有用武之處。

```lambda```運算式會建立一個與def陳述式一樣的函式物件，這是其中一種python可呼叫物件的其中一種。

## 七種可呼叫物件
調用運算符（即```()```）也可以應用於其他對象。要檢查對像是否可調用，請使用```callable()```。
```python
callable(map) # true, 因為map是內建函式
```

Python數據模型中定義了7種可調用類型
 1. 自訂函式 - 使用```def```或```lambda```創建
 2. 內建函式 - CPython實現。例如```len```或```time.strftime```
 3. 內建方法 — 用C語言實現的方法```dict.get```
 4. 方法 - 在類別主體中定義的函數
 5. 類別 - 創建類的新實例調用```__new__```和```__init__```
 6. 類別實例 — 如果一個類別定義了```__call__```方法
 7. 生成器函數 - 具有```yeild```關鍵字的函數/方法

判斷是否可呼叫：
```python
abs, str, 13
# <built-in function abs>, <class 'str'>, 13>
[callable(obj) for obj in (abs, str, 13)]
# [True, True, False]
```

## 定義可呼叫型態

任意 Python 對像也可以通過實現```__call__```實例方法來表現得像函數，意指使實例能夠像函式一樣被調用。

```python
import random

class BingoCage:
    
    def __init__(self, items):
        self._items = list(items)
        random.shuffle(self._items)
        
    def pick(self):
        try:
            return self._items.pop()
        except IndexError:
            raise LookupError('pick from empty BingoCage')
            
    def __call__(self):
        return self.pick()
```

```python
bingo = BingoCage(range(3))
bingo.pick() # 2

# 通過BingoCage類實現__call__()方法，使bingo實例變成可調用的對象
bingo() # 0
# 可改寫為bingo.__call__()
```

## 函式自我檢查

使用```dir```函式為我們揭曉函式底下的所有東西

```python
dir(factorial)
# ['__annotations__', '__call__', '__class__', '__closure__', '__code__',
 '__defaults__', '__delattr__', '__dict__', '__dir__', '__doc__',
 '__eq__', '__format__', '__ge__', '__get__', '__getattribute__', '__globals__',
 '__gt__', '__hash__', '__init__', '__init_subclass__', '__kwdefaults__', '__le__',
 '__lt__', '__module__', '__name__', '__ne__', '__new__', '__qualname__',
 '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__',
 '__str__', '__subclasshook__']
```

這些屬性大部分在一般物件都能找到，但這邊我們要討論“把函式當成物件”特別有關係的屬性: ```__dict__```

ref: [http://c.biancheng.net/view/2374.html)]

### 函式專用屬性

上面用可以看到函式擁有很多屬性，但在python的自性物件中，不會跟函式一樣有那麼多，我們可以透過以下的方法來查看函式專用的屬性

```python
class C: pass
obj = C()

def func(): pass

sorted(set(dir(func)) - set(dir(obj)))
# ['__annotations__',
 '__call__',
 '__closure__',
 '__code__',
 '__defaults__',
 '__get__',
 '__globals__',
 '__kwdefaults__',
 '__name__',
 '__qualname__']
```

## 從定位參數到只限使用關鍵字的參數
